---
title: 集群管理
date: 2023-12-24 15:12:09
permalink: /pages/cluster/
categories:
  - docs
  - 文档
  - 工作空间&集群
tags:
  - 
---

## 前言

Jpom 服务端执行集群化管理和部署，但是注意是是逻辑集群来实现的（可能和您认为的集群稍微有一点差异）

:::tip 一句话总结
搭建多个服务端并且指向同一个数据库使用分组来实现逻辑区分和管控
:::


整个架构图如下：

![集群架构图](/images/cluster-tree.png)

:::danger 说明
插件端自身没有必要做集群，请您不要问出如何对插件端集群化。如果您真需要那么您应该了解服务端中的`节点分发`功能
:::

## 为啥要集群？

其实在我们日常使用绝大多数情况是无需集群化的，因为单体服务端基本够用，如果不够那么**加钱？（扩容服务器）**

但是您的诉求就是需要对服务端进行集群化来实现资源隔离使用，那么也是可以实现的。

### 痛点

首先你要知道 Jpom 服务端本身消耗资源的痛点在哪里，因为您集群化无非就是需要对服务器资源消耗进行把控和隔离。

服务端资源消耗的痛点在：`在线构建` 即项目打包部署，尤其是 node 项目在打包是资源消耗高。

理论上服务端除去`在线构建`功能之外其他功能均不会消耗过多资源，当您理解到痛点后我们继续看如何解决痛点。

:::tip 补充说明
- 在线构建消耗资源的原因不在于 jpom 服务端本身，而已调用相关插件而引起的资源消耗
- 不同构建方式使用到到依赖插件不同消耗资源也不同，同时资源消耗和您项目本身大小有一定关系
:::

### 如何解决？

既然在线构建消耗资源，那么我们应该想法扩容服务器或者分散服务器来执行构建。

1. 扩容最简单也是最有效的来。
2. 分散服务器，使用多个服务器来构建项目（复杂度高）


本文主要从分散服务器的方式来说明

## 前提条件

需要使用集群您需要先满足如下条件才更快的帮助您配置集群

### 数据库

如果您需要集群化部署那么您服务端的数据库必须使用或者提前迁移到 mysql 中。

### 工作空间准备

jpom 中的工作空间我相信您已经了解或者已经会使用了(**如果不会请看文档**)，如果需要集群的话则需要您提前将期望`存放/归属`不同集群的数据使用工作空间来划分。

因为 Jpom 中的逻辑集群绑定到不同的工作空间来实现数据切换或者资源使用。

并且您还需要对您的资产进行分组配置来指定对应的资产应该归属到哪个集群中来管理。

### 集群网络互通

这里是一个大前提奥。

您需要保证您的服务端 A 能连接到您的数据同时服务端 B 也能连接到您的数据库。

集群配置好后:

- 服务端 A 也等同于集群 A
- 服务端 B 也等同于集群 B

单个集群中的资产信息也需要保证网络互通。

## 集群创建

您想在服务端中创建集群，那么当您服务端的数据库已经使用 mysql 后，您只需要在您新机器上安装一个全新的服务端，并且配置数据库信息为之前服务端相同的即可。

成功后操作路径：【系统管理】->【服务端配置】->【工作空间&集群】-> [集群管理选项卡]

![集群管理列表](/images/databases/847801ba8e85efda498c4a0ca26c33ce.png)

可以看到已经有一条新的集群记录啦

:::tip 规则说明
服务端中集群是使用`安装 id`来区分的，因为您全新安装时会自动生成一个新的`安装 id`
:::


### 集群安装 ID

集群安装 ID 创建规则：当服务端在启动时候会自动检查数据目录中是否存在：`INSTALL.json` 文件，如果不存在则进行自动创建

文件数据示例：

```json
{
        "installTime":"2021-03-16 17:05:32",
        "installId":"91c653b3e17c4021b486416e33d014c8",
        "desc":"请勿删除此文件,服务端安装id和插件端互通关联"
}
```

其中的 `installId` 为当前集群 id,并且集群数据会自动写入到数据库中，集群安装 id 生成规则是 `uuid`

程序会检查到当前程序的集群安装 id 在数据库中未存在则自动创建一条新记录。


## 配置集群

在您配置集群前您需要对您集群进行以下配置：

- 修改集群 ID
- 已经存在的资产信息进行分组


### 修改集群 ID

系统默认的集群 ID 值为：`DEFAULT`

在同一个系统中不同的集群 ID 需要配置为不同的值才能正常使用，反之您在服务端控制台（系统日志）将看到如下错误信息：

```log
DEFAULT 集群ID冲突：7a175577b0d042c79c1a56b70de4996c 默认集群
```

修改集群 id 路径：【服务端管理】->【服务端配置】->【系统配置】->【服务端系统配置】

`jpom.cluster.id`

![修改集群ID](/images/cluster/6a89d7af8e69908538962eda70151af2.png)


### 资产分组

在您配置集群前您需要对您已经存在的资产信息进行分组

资产分组的目的是实现您不同集群下的资产监控和调度

:::danger 温馨提醒
当您在使用集群功能时，发现资产状态监控不正确，但是您的资产的确在线那么您就需要检查一下对应资产分组绑定的集群是否正常
:::

需要分组的资产有：

- 机器数据
- SSH 数据
- Docker 数据


配置路径：【系统管理】->【资产管理】->(【机器管理】、【SSH管理】【Docker管理】)

### 未绑定集群的分组

如果您在集群页面里面发现存在未绑定集群的分组数据时，您需要检查对应分组中的资产数据应该绑定到哪个集群分组然后进行配置绑定


![集群分组提示](/images/cluster/98bdeee98d70e918658a82e1f962aa0b.png)

![编辑集群](/images/cluster/2aa65dc93c74a7944a92dc70bbb9a142.png)

![编辑集群页面状态](/images/cluster/a6cfd04f4bdf7356f6bc94c4ebb75954.png)

### 集群地址

因为在 jpom 中实际是安装来多个服务端，如果您需要使用到对应的集群下面的工作空间数据，您还需要访问对应集群的真实地址来达到管理控制对应服务端（集群）。


所以集群地址，请填写对应集群的真实访问地址（可以是反向代理后的）

### 工作空间绑定集群

当您上次操作均完成后您还有最后一步就是给对应工作空间绑定一个集群来实现工作空间和集群关系能一一对应。

![工作空间绑定集群](/images/cluster/ed64da307fd296738380b3d7bb63daf7.png)

![工作空间绑定集群2](/images/cluster/057e74f1ffeca162e0c0151fc903390d.png)


## 切换集群

当您为所有集群都配置来访问地址时您可以在【右上角昵称】->【下拉处】切换

如果您未配置集群的访问地址可以看到集群名，但是切换按钮是禁用状态。

![无非切换集群](/images/cluster/3cea7b54a228c319207d3fce6734afe0.png)


您配置正确的地址后按钮即可用：

![正常切换集群](/images/cluster/190c77c9475e3ed370442ae3904c1681.png)

点击您想要切换到的集群后即可跳转到对应集群，当然您也可以手动在浏览器输入集群地址访问。

## 删除集群

当您想删除某个集群流程比较简单

1. 停止对应集群服务端并卸载
2. 解绑工作空间和集群关系
3. 资产分组解绑
   1. 将需要删除集群绑定的资产分组重新分配到新集群
4. 删除集群


如果您在删除中提示：**不能删除在线的集群** 那么说明您选错要删除集群了

系统中如果当前集群还在心跳（在线）是不能删除的，心跳机制是 `30 秒`一次

如果您在删除中提示：**当前集群还被工作空间绑定不能删除** 那么说明您未解绑集群和工作空间关系。

## 修改集群心跳

心跳默认 30 秒检查集群在线状态，前提是已经配置集群地址后。

您可以自定义检查集群状态时间：


修改集群心跳路径：【服务端管理】->【服务端配置】->【系统配置】->【服务端系统配置】

`jpom.cluster.heart-second`

![修改集群心跳](/images/cluster/6a89d7af8e69908538962eda70151af2.png)