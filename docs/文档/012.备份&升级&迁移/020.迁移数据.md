---
title: 迁移数据
date: 2023-12-23 17:15:45
permalink: /pages/dec2a1/
categories:
  - docs
  - 文档
  - 如何升级&迁移
tags:
  - 
---

## 前言

由于各种因素我们时常需要对 Jpom 进行数据迁移，当您需要迁移时请先仔细阅读该文档帮助您避坑

:::tip 提醒
- 本文涉及到流程和说明较多，为来您的数据安全建议您先全部阅读后再进行操作

- 迁移数据有风险请提前做好数据备份
:::

## 情况判断

迁移数据根据实际情况又分为几种

- 完整迁移
- 部分迁移
- 数据还原/导入


## 完整迁移

完整迁移是指当您旧环境还能正常使用新环境已经准备 OK 就只需要迁移程序和数据

### 服务端（原生本地安装）

当前说明是指您使用原生本地安装的方式，并非使用容器安装的情况

当您当新环境（机器/服务器）已经准备好了，请您先根据旧环境中的依赖和插件提前安装和进行环境变量配置（此步骤本文档默认您已经会了并且配置 OK）

一般情况下依赖如下：

- jdk 必须
- maven 可选
- node 可选
- 服务器字体 可选（验证码相关）
- 网络 （新环境和所有节点机器、SSH 机器、Docker 机器）
- 数据库网络 （如果使用了 mysql 数据库）


------------

#### 开始迁移流程

----------

#### 关闭旧环境服务端

先关闭旧环境服务端来保证已经没有新的操作和请求造成迁移过程中产生数据影响数据完整性

```shell
sh ./bin/Server.sh stop
```

```shell
./bin/Server.bat stop
```

----------

#### 决定需要迁移的目录

为了数据安全和稳定我们建议您先 copy 服务端的整个目录进行操作，避免操作过程中的误操作造成数据丢失。

当您 copy 出新目录后您可以开始选择把不需要的迁移的目录或者文件删除

比如如下目录您可以选择不迁移：

- logs
- tmp
- data/temp
- data/script_run_cache

慎重选择：如果您迁移时候发现 `data/build` 目录非常大严重影响您的备份效率，此时您需要评估在线构建中缓存的仓库数据、构建日志、构建产物是否可以容忍丢失。

如果能容忍丢失那么您可以选择删除 `data/build` 目录。

如果您想保留部分构建仓库数据、构建日志、构建产物数据，那么您需要先知道想保留的构建的`数据 ID`。

怎么获取构建数据 ID,我相信您一定知道浏览器的调试控制台->网络选项卡（说到这里了懂的都懂，不懂的问度娘）

获取到您需要保留的数据 ID 后，您将不需要保留的构建数据删除即可 `data/build/数据 ID`

----------

#### 打包整个目录并下载

打包目录这个不用说了吧

linux 推荐用：tar

windows 您喜好

为什么需要打包呢？不能直接下载目录吗？

当您有这个疑问时说明您不知道在网络中，`上传/下载`多个小文件和`上传/下载`一个大文件的效率问题,反正推荐压缩打包后进行传输，极其不推荐直接传输整个目录。

----------

#### 上传备份文件到新环境

当您打包后到文件下载到本地或者直接传输到新环境。

如果您是下载到本地那么您还需要将文件上传到新环境中。

----------

#### 确认新环境准备完毕

上面已经说明了，需要您提前在新环境中安装旧环境中相关的依赖插件。

这里我们建议您新环境中使用插件版本和旧环境中的版本号和安装方式一直，来减少新环境中遇到各种奇奇乖乖的依赖环境不正确的问题

----------

#### 启动服务端

但您环境确认完毕后，即可启动服务端

```shell
sh ./bin/Server.sh start
```

```shell
./bin/Server.bat start
```

期待您顺利启动。

如果启动失败请根据错误日志来排查定位相关问题（您也可以联系我们协助排查）

----------

#### 检查是否需要安装服务

如果您之前注册过开机启动服务，您还需要使用之前相同方式来在新机器中注册服务并开启开机自启

Linux：

```shell
bash /xxxx/bin/Service.sh install
```

Windows:

自行实现

----------

#### 确认访问

当新环境启动成功后，您需要使用新 IP 访问系统，如果使用到了反向代理您还需要修改反向代理的配置来达到可以正常访问

----------

#### 检查系统是否正常

使用账户密码登陆到新系统中来检查数据是否完成，资产数据连接是否正常

#### 正常使用

当您一切都检查 ok 无问题后您就可以在新环境中使用 jpom 啦，不要忘记将新环境的地址告知给其他使用平台的用户奥

----------

### 插件端

:::danger 说明
- 本文中仅说明如果迁移 jpom 插件端，如果您对呀服务端里面包含项目数据还您你自行迁移。迁移服务器中其他数据不在本文说明范畴.
- 机器关联的项目数据迁移是一个极其麻烦的事情您自己想要了解并知道该如何迁移。
- 如果仅迁移插件端未迁移机器中的项目数据那么可能造成在 Jpom 系统中看到项目状态是未运行和无法看到项目的任何文件。
:::

当您当新环境（机器/服务器）已经准备好了，请您先根据旧环境中的依赖和插件提前安装和进行环境变量配置（此步骤本文档默认您已经会了并且配置 OK）

一般情况下依赖如下：

- jdk 必须
- 项目数据 【自行判断】
- 网络 （服务端能否访问到新环境）

#### 开始迁移流程

#### 关闭旧环境服务端

先关闭旧环境服务端来保证已经没有新的操作和请求造成迁移过程中产生数据影响数据完整性

```shell
sh ./bin/Agent.sh stop
```

```shell
./bin/Agent.bat stop
```

----------

#### 决定需要迁移的目录

为了数据安全和稳定我们建议您先 copy 服务端的整个目录进行操作，避免操作过程中的误操作造成数据丢失。

当您 copy 出新目录后您可以开始选择把不需要的迁移的目录或者文件删除

比如如下目录您可以选择不迁移：

- logs
- tmp
- data/temp
- data/script_run_cache
- data/script

慎重选择：如果您迁移时候发现 `data/script` 目录非常大严重影响您的备份效率，此时您需要评估节点脚步日志是否可以容忍丢失。

如果能容忍丢失那么您可以选择删除 `data/script` 目录。

如果您想保留部分节点脚步日志数据，那么您需要先知道想保留的脚本的`数据 ID`。

怎么获取脚步数据 ID,我相信您一定知道浏览器的调试控制台->网络选项卡（说到这里了懂的都懂，不懂的问度娘）

获取到您需要保留的数据 ID 后，您将不需要保留的脚步日志数据删除即可 `data/script/数据 ID`

----------


#### 打包整个目录并下载

打包目录这个不用说了吧

linux 推荐用：tar

windows 您喜好

为什么需要打包呢？不能直接下载目录吗？

当您有这个疑问时说明您不知道在网络中，`上传/下载`多个小文件和`上传/下载`一个大文件的效率问题,反正推荐压缩打包后进行传输，极其不推荐直接传输整个目录。

----------

#### 上传备份文件到新环境

当您打包后到文件下载到本地或者直接传输到新环境。

如果您是下载到本地那么您还需要将文件上传到新环境中。

----------

#### 确认新环境准备完毕

上面已经说明了，需要您提前在新环境中安装旧环境中相关的依赖插件。

这里我们建议您新环境中使用插件版本和旧环境中的版本号和安装方式一直，来减少新环境中遇到各种奇奇乖乖的依赖环境不正确的问题

----------

#### 启动插件端

但您环境确认完毕后，即可启动插件端

```shell
sh ./bin/Agent.sh start
```

```shell
./bin/Agent.bat start
```

期待您顺利启动。

如果启动失败请根据错误日志来排查定位相关问题（您也可以联系我们协助排查）

----------

#### 检查是否需要安装服务

如果您之前注册过开机启动服务，您还需要使用之前相同方式来在新机器中注册服务并开启开机自启

Linux：

```shell
bash /xxxx/bin/Service.sh install
```

Windows:

自行实现

----------

#### 修改机器节点地址

使用管理员账户登陆到服务端中，【系统管理】->【资产管理】->【机器管理】 中找到对应机器节点的数据编辑节点，修改其地址为新的 IP 地址

----------

#### 检查节点是否正常

当您上述操作均成功后，您需要在 Jpom 系统中来检查您的节点是否可以正常连接，如果不能正常连接请检查网络限制相关问题

您还需要建议此插件端机器中的项目数据是否正常（此流程不可控需要您清楚您项目是否迁移完成）

----------

> 注意：因为您使用文件迁移的方式并也迁移了配置文件，理论上无论您使用什么数据库均是此流程

## 部分迁移

部分迁移是指您您想将旧环境数据导入或者迁移到新环境，旧环境中的历史记录日志和缓存均可以丢弃。

### 服务端（原生本地安装）

关于服务端数据的总结：

- db 核心数据
- conf 配置文件夹
- data/INSTALL.json 安装ID/集群ID

关于 db ：`Server.mv.db`、`Server.trace.db` 是最新的完整数据

其他目录的数据均是使用过程中的数据：`文件中心`、`证书文件`、`构建数据` 想要您看是否使用到对应功能和是否重要以及有备份。

自行选择选择使用过程中的数据是否迁移。

#### 开始迁移流程

----------

#### 关闭旧环境服务端

先关闭旧环境服务端来保证已经没有新的操作和请求造成迁移过程中产生数据影响数据完整性

```shell
sh ./bin/Server.sh stop
```

```shell
./bin/Server.bat stop
```

----------

#### 决定需要迁移的目录

根据上述描述选择您需要迁移的文件及文件夹

为了数据安全和稳定我们建议您先 copy 服务端的整个目录进行操作，避免操作过程中的误操作造成数据丢失。

当您 copy 出新目录后您可以开始选择把不需要的迁移的目录或者文件删除

----------

#### 后续流程和上面完整迁移一致

后续流程和上面完整迁移一致，请先仔细阅读完整迁移的流程

部分迁移和完整迁移的区别主要是选择的迁移数据的范围不同

----------

### 插件端

:::danger 提示
- 由于插件端数据较少，部分迁移和完整迁移流程和选择方式一致，请参考完整迁移流程
- 绝大多数情况下我们建议插件端均采用完整迁移，但是需要考虑对应服务器中的项目数据迁移情况
:::

> 注意：因为您使用文件迁移的方式并也迁移了配置文件，理论上无论您使用什么数据库均是此流程

## 数据还原/导入

在一些情况下您已经在新环境中全新安装 Jpom 现在想把之前环境中的数据导入或者还原到新环境中.

**或者您想将 A 环境（非全新）中的数据导入到 B 环境中（不推荐此做法）**

:::tip 注意
使用 h2 数据库和使用 mysql 数据库的流程不一样奥。请根据您的情况选择不同流程
:::

### 服务端[H2数据库]（原生本地安装）


:::danger 风险提示
如果您已经安装过服务端并且已经在使用或者已经添加资产数据、节点数据、项目数据，此情况非常不建议您操作数据还原/导入，因为还原/导入操作后两个环境中的数据可能冲出或者数据冗余产生很多未知问题和不可控的数据异常相关问题
:::



如果您是全新安装还未正式使用，仅是安装后初始化超级管理员账号（必须操作）。

**⚠️注意：不要对其他数据进行添加操作，请仔细阅读下文操作流程说明**

#### 创建数据备份（旧环境）

操作路径：【系统管理】->【服务端管理】->【数据库备份】

##### 1. 创建最新的【全量备份】

![全量备份](/images/databases/364e0401d8da54077fef10076831fe5f.png)

##### 2. 等待备份状态完成

备份根据您数据量大小耗时不一样，请耐心等待。页面中的数据非自动刷新请定期手动刷新便于及时知道备份状态

##### 3. 下载备份文件

当备份成功后我们将对应的数据文件下载到本地

![Alt text](/images/databases/5c0b6789e677af64511984a0b0a97993.png)

##### 4. 关闭旧环境

上述操作完成后我们建议您关闭此系统，避免再次使用过程中产生数据造成和新环境中期望的数据不一致

#### 全新安装服务端（新环境）

在您期望导入/还原到的新服务器中安装好服务端所需要的所有依赖和您需要的插件

一般情况下依赖如下：

- jdk 必须
- maven 可选
- node 可选
- 服务器字体 可选（验证码相关）
- 网络 （新环境和所有节点机器、SSH 机器、Docker 机器）

#### 确认是否迁移配置文件

新环境安装完成后您要确认您是否对服务端进行过自定义配置（conf）：

- application.yml
- logback.xml
- 自定义容器构建插件
- 修改容器构建插件
- 脚本执行模板

如果您没有对齐进行修改过可以忽略此步骤用全新默认配置即可

**如果有修改请手动同步修改过的配置文件！！！**

#### 初始化服务端

访问服务端：先确认您能正常访问到新环境中的服务端

先对服务端进行一个简单的初始化配置管理员账户密码

![install1](/images/tutorial/project_dsl_java/inits1.png)

#### 将备份数据导入到新环境（导入备份）

初始化完成后进入系统，请不要进行其他任何数据的添加或者配置。

直接到数据库备份中导入备份

操作路径：【系统管理】->【服务端管理】->【数据库备份】

![导入备份](/images/databases/6a7922ee33e44bacecf65bad562e94e5.png)

#### 选择对应记录进行还原（还原备份）

导入成功后，对指定记录进行还原

> 截图不一定和上文一致（但流程一致）

![还原备份](/images/databases/54d6de04ec767ad414cb2fa8bcbcb5ac.png)

#### 等待还原结果

还原成功后会自动跳转到登录页面，因为之前数据库中的账户和您新配置的账户的 `slat` 有差异。

使用旧环境中的原始账户登录，进入系统后检查数据的完整性

:::tip 注意
此时您访问系统中仅能看到数据记录，没有程序需要使用的相关文件
:::

#### 选择迁移关联文件

根据您系统中的不同文件的重要性选择性的将旧环境中的文件迁移到新环境中

> 注意：一定保留原始的相对目录层级和结构

可选迁移的文件有如下：

- data/build
- data/script
- data/command_log
- data/file-storage
- data/certificate
- data/docker
- 更多请自行选择

需要同步迁移请手动从旧环境迁移到新环境中即可

**迁移完成后重启一下服务端**

#### 同步集群 ID【重要】

:::tip 注意
当前流程说明的是使用 H2 数据库，使用 H2 数据库是不支持集群的，但是我们仍需要对集群 ID 进行修正同步
:::

服务器中会自动创建一个集群，一般情况下您无法使用到集群功能，但是您导入/还原前后后仍需要进行一次集群 ID 确认修正，避免后续数据异常无法排查等未知错误

集群 ID 创建规则：当服务端在启动时候会自动检查数据目录中是否存在：`INSTALL.json` 文件，如果不存在则进行自动创建

文件数据示例：

```json
{
        "installTime":"2021-03-16 17:05:32",
        "installId":"91c653b3e17c4021b486416e33d014c8",
        "desc":"请勿删除此文件,服务端安装id和插件端互通关联"
}
```

其中的 `installId` 为当前集群 id,并且集群数据会自动写入到数据库中，集群 id 生成规则是 `uuid`

程序会检查到当前程序的集群 id 在数据库中未存在则自动创建一条新记录。

这样经过上述操作可能数据库中已经存在多条集群记录了（初次安装数据库已经存在新集群 id、导入数据存在旧集群 id），此时我们就需要进行手动修正。

##### 修正流程如下

1. 旧环境中找到 `INSTALL.json` 文件，查看  `installId` 值
2. 将新环境中的的 `INSTALL.json` 文件， `installId` 值修改为和旧环境一致的值
3. 重启服务端

##### 删除已经弃用的集群数据

操作路径：【系统管理】->【服务端配置】->【工作空间&集群】-> [集群管理选项卡]

找到对应已经弃用的集群 id 。

**这里注意选择弃用 id 规则如下：非当前`INSTALL.json`文件`installId` 值即为弃用**

![集群管理列表](/images/databases/847801ba8e85efda498c4a0ca26c33ce.png)

如果您在删除中提示：**不能删除在线的集群** 那么说明您选错要删除集群了

系统中如果当前集群还在心跳（在线）是不能删除的，心跳机制是 `30 秒`一次

如果您在删除中提示：**当前集群还被工作空间绑定不能删除** 那么说明您选错要删除集群了，说明此集群之前已经被工作空间绑定啦（因为我们系统会默认给未绑定集群的工作空间自动绑定最新集群，旧数据已经自动绑定啦，所以您在修正集群 ID 时需要保留使用旧环境中的集群 ID）

正常情况下使用 H2 数据时非集群默认，此列表仅存在一条记录时是正常的

#### 正常使用

当您一切都检查 ok 无问题后您就可以在新环境中使用 jpom 啦，不要忘记将新环境的地址告知给其他使用平台的用户奥

:::danger 友情提醒
上述操作流程时选用最复杂的流程来讲解，其实您可以在新环境中安装后服务端后不要启动，直接同步需要的文件到新环境中可以省去一些流程
:::