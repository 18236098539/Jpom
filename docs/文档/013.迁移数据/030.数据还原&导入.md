---
title: 还原&导入
date: 2023-12-24 11:35:54
permalink: /pages/643951/
categories:
  - docs
  - 文档
  - 备份&升级&迁移
  - 迁移数据
tags:
  - 
---

## 前言

数据还原/导入

在一些情况下您已经在新环境中全新安装 Jpom 现在想把之前环境中的数据导入或者还原到新环境中.

**或者您想将 A 环境（非全新）中的数据导入到 B 环境中（不推荐此做法）**

:::tip 注意
使用 h2 数据库和使用 mysql 数据库的流程不一样奥。请根据您的情况选择不同流程
:::

## 服务端[H2数据库]（原生本地安装）


:::danger 风险提示
如果您已经安装过服务端并且已经在使用或者已经添加资产数据、节点数据、项目数据，此情况非常不建议您操作数据还原/导入，因为还原/导入操作后两个环境中的数据可能冲出或者数据冗余产生很多未知问题和不可控的数据异常相关问题
:::



如果您是全新安装还未正式使用，仅是安装后初始化超级管理员账号（必须操作）。

**⚠️注意：不要对其他数据进行添加操作，请仔细阅读下文操作流程说明**

### 创建数据备份（旧环境）

操作路径：【系统管理】->【服务端管理】->【数据库备份】

#### 1. 创建最新的【全量备份】

![全量备份](/images/databases/364e0401d8da54077fef10076831fe5f.png)

#### 2. 等待备份状态完成

备份根据您数据量大小耗时不一样，请耐心等待。页面中的数据非自动刷新请定期手动刷新便于及时知道备份状态

#### 3. 下载备份文件

当备份成功后我们将对应的数据文件下载到本地

![Alt text](/images/databases/5c0b6789e677af64511984a0b0a97993.png)

#### 4. 关闭旧环境

上述操作完成后我们建议您关闭此系统，避免再次使用过程中产生数据造成和新环境中期望的数据不一致

### 全新安装服务端（新环境）

在您期望导入/还原到的新服务器中安装好服务端所需要的所有依赖和您需要的插件

一般情况下依赖如下：

- jdk 必须
- maven 可选
- node 可选
- 服务器字体 可选（验证码相关）
- 网络 （新环境和所有节点机器、SSH 机器、Docker 机器）

### 检查是否需要安装服务

如果您之前注册过开机启动服务，您还需要使用之前相同方式来在新机器中注册服务并开启开机自启

Linux：

```shell
bash /xxxx/bin/Service.sh install
```

Windows:

自行实现

安装服务后不要忘记设置开机自启奥！

----------

### 确认是否迁移配置文件

新环境安装完成后您要确认您是否对服务端进行过自定义配置（conf）：

- application.yml
- logback.xml
- 自定义容器构建插件
- 修改容器构建插件
- 脚本执行模板

如果您没有对齐进行修改过可以忽略此步骤用全新默认配置即可

**如果有修改请手动同步修改过的配置文件！！！**

### 初始化服务端

访问服务端：先确认您能正常访问到新环境中的服务端

先对服务端进行一个简单的初始化配置管理员账户密码

![install1](/images/tutorial/project_dsl_java/inits1.png)

### 将备份数据导入到新环境（导入备份）

初始化完成后进入系统，请不要进行其他任何数据的添加或者配置。

直接到数据库备份中导入备份

操作路径：【系统管理】->【服务端管理】->【数据库备份】

![导入备份](/images/databases/6a7922ee33e44bacecf65bad562e94e5.png)

### 选择对应记录进行还原（还原备份）

导入成功后，对指定记录进行还原

> 截图不一定和上文一致（但流程一致）

![还原备份](/images/databases/54d6de04ec767ad414cb2fa8bcbcb5ac.png)

### 等待还原结果

还原成功后会自动跳转到登录页面，因为之前数据库中的账户和您新配置的账户的 `slat` 有差异。

使用旧环境中的原始账户登录，进入系统后检查数据的完整性

:::tip 注意
此时您访问系统中仅能看到数据记录，没有程序需要使用的相关文件
:::

### 选择迁移关联文件

根据您系统中的不同文件的重要性选择性的将旧环境中的文件迁移到新环境中

> 注意：一定保留原始的相对目录层级和结构

可选迁移的文件有如下：

- data/build
- data/script
- data/command_log
- data/file-storage
- data/certificate
- data/docker
- 更多请自行选择

需要同步迁移请手动从旧环境迁移到新环境中即可

**迁移完成后重启一下服务端**

### 同步集群安装 ID【重要】

:::tip 注意
当前流程说明的是使用 H2 数据库，使用 H2 数据库是不支持集群的，但是我们仍需要对集群安装 id 进行修正同步
:::

服务器中会自动创建一个集群，一般情况下您无法使用到集群功能，但是您导入/还原前后后仍需要进行一次集群安装 id 确认修正，避免后续数据异常无法排查等未知错误

集群安装 id 创建规则：当服务端在启动时候会自动检查数据目录中是否存在：`INSTALL.json` 文件，如果不存在则进行自动创建

文件数据示例：

```json
{
        "installTime":"2021-03-16 17:05:32",
        "installId":"91c653b3e17c4021b486416e33d014c8",
        "desc":"请勿删除此文件,服务端安装id和插件端互通关联"
}
```

其中的 `installId` 为当前集群安装 id,并且集群数据会自动写入到数据库中，集群安装 id 生成规则是 `uuid`

程序会检查到当前程序的集群安装 id 在数据库中未存在则自动创建一条新记录。

这样经过上述操作可能数据库中已经存在多条集群记录了（初次安装数据库已经存在新集群安装 id、导入数据存在旧集群安装 id），此时我们就需要进行手动修正。

#### 修正流程如下

1. 旧环境中找到 `INSTALL.json` 文件，查看  `installId` 值
2. 将新环境中的的 `INSTALL.json` 文件， `installId` 值修改为和旧环境一致的值
3. 重启服务端

#### 删除已经弃用的集群数据

操作路径：【系统管理】->【服务端配置】->【工作空间&集群】-> [集群管理选项卡]

找到对应已经弃用的集群安装 id 。

**这里注意选择弃用 id 规则如下：非当前`INSTALL.json`文件`installId` 值即为弃用**

![集群管理列表](/images/databases/847801ba8e85efda498c4a0ca26c33ce.png)

如果您在删除中提示：**不能删除在线的集群** 那么说明您选错要删除集群了

系统中如果当前集群还在心跳（在线）是不能删除的，心跳机制是 `30 秒`一次

如果您在删除中提示：**当前集群还被工作空间绑定不能删除** 那么说明您选错要删除集群了，说明此集群之前已经被工作空间绑定啦（因为我们系统会默认给未绑定集群的工作空间自动绑定最新集群，旧数据已经自动绑定啦，所以您在修正集群安装 id 时需要保留使用旧环境中的集群安装 id）

正常情况下使用 H2 数据时非集群默认，此列表仅存在一条记录时是正常的

### 正常使用

当您一切都检查 ok 无问题后您就可以在新环境中使用 jpom 啦，不要忘记将新环境的地址告知给其他使用平台的用户奥

:::danger 友情提醒
上述操作流程时选用最复杂的流程来讲解，其实您可以在新环境中安装后服务端后不要启动，直接同步需要的文件到新环境中可以省去一些流程
:::

## 服务端[MYSQL数据库]（原生本地安装）

如果您使用的是 mysql 数据库那么就涉及到两种情况，您是迁移数据库还是迁移服务端所在的服务器。

### 迁移数据库

迁移数据库其实算比较简单的，因为 mysql 非常成熟方案多种多样您选择您最擅长的即可（如果不会那搜索引擎是您最佳选择）。

:::tip 提醒
- 迁移数据库前请先停止服务端避免在迁移过程中产生新数据（一般推荐使用停机迁移，非停机迁移请自行研究）
- 迁移数据库注意不仅需要迁移表还要迁移数据库：`函数`和`存储过程`
:::

当您确认数据库迁移完成后，到服务端修改数据库连接新鲜配置。

配置文件路径： `服务端安装路径/conf/application.yml`

修改配置后重启服务端即可

### 迁移服务器

#### 全新安装服务端（新环境）

在您期望导入/还原到的新服务器中安装好服务端所需要的所有依赖和您需要的插件

一般情况下依赖如下：

- jdk 必须
- maven 可选
- node 可选
- 服务器字体 可选（验证码相关）
- 网络 （新环境和所有节点机器、SSH 机器、Docker 机器）
- 数据库网络

:::tip 提醒
安装完成后我们建议您不要启动服务端、等后续流程操作后再启动
:::

#### 检查是否需要安装服务

如果您之前注册过开机启动服务，您还需要使用之前相同方式来在新机器中注册服务并开启开机自启

Linux：

```shell
bash /xxxx/bin/Service.sh install
```

Windows:

自行实现

安装服务后不要忘记设置开机自启奥！

----------

#### 确认是否迁移配置文件

新环境安装完成后您要确认您是否对服务端进行过自定义配置（conf）：

- application.yml
- logback.xml
- 自定义容器构建插件
- 修改容器构建插件
- 脚本执行模板

如果您没有对齐进行修改过可以忽略此步骤用全新默认配置即可

**如果有修改请手动同步修改过的配置文件！！！**

#### 修改数据库配置（新环境）

当您在新环境已经安装好后，如果您没有同步 `application.yml` 文件，这里您还需要手动修改数据库配置信息为您 mysql 数据库信息

配置文件路径： `服务端安装路径/conf/application.yml`

![修改数据库配置](/images/databases/5e64fe04bfd8363b6c74ea86f5c867f1.png)

#### 选择迁移关联文件

根据您系统中的不同文件的重要性选择性的将旧环境中的文件迁移到新环境中

> 注意：一定保留原始的相对目录层级和结构

可选迁移的文件有如下：

- data/build
- data/script
- data/command_log
- data/file-storage
- data/certificate
- data/docker
- 更多请自行选择

需要同步迁移请手动从旧环境迁移到新环境中即可

**迁移完成后重启一下服务端**

#### 同步集群安装 ID【重要】

:::tip 注意
如果您在安装新环境后未启动，或者启动前手动同步过 `INSTALL.json` 可以忽略此步骤（建议还是检查一下）
:::

服务器中会自动创建一个集群，一般情况下您无法使用到集群功能，但是您导入/还原前后后仍需要进行一次集群安装 id 确认修正，避免后续数据异常无法排查等未知错误

集群安装 id 创建规则：当服务端在启动时候会自动检查数据目录中是否存在：`INSTALL.json` 文件，如果不存在则进行自动创建

文件数据示例：

```json
{
        "installTime":"2021-03-16 17:05:32",
        "installId":"91c653b3e17c4021b486416e33d014c8",
        "desc":"请勿删除此文件,服务端安装id和插件端互通关联"
}
```

其中的 `installId` 为当前集群安装 id,并且集群数据会自动写入到数据库中，集群安装 id 生成规则是 `uuid`

程序会检查到当前程序的集群安装 id 在数据库中未存在则自动创建一条新记录。

这样经过上述操作可能数据库中已经存在多条集群记录了（初次安装数据库已经存在新集群安装 id、导入数据存在旧集群安装 id），此时我们就需要进行手动修正。

##### 修正流程如下

1. 旧环境中找到 `INSTALL.json` 文件，查看  `installId` 值
2. 将新环境中的的 `INSTALL.json` 文件， `installId` 值修改为和旧环境一致的值
3. 重启服务端

##### 删除已经弃用的集群数据

操作路径：【系统管理】->【服务端配置】->【工作空间&集群】-> [集群管理选项卡]

找到对应已经弃用的集群安装 id 。

**这里注意选择弃用 id 规则如下：非当前`INSTALL.json`文件`installId` 值即为弃用**

![集群管理列表](/images/databases/847801ba8e85efda498c4a0ca26c33ce.png)

如果您在删除中提示：**不能删除在线的集群** 那么说明您选错要删除集群了

系统中如果当前集群还在心跳（在线）是不能删除的，心跳机制是 `30 秒`一次

如果您在删除中提示：**当前集群还被工作空间绑定不能删除** 那么说明您选错要删除集群了，说明此集群之前已经被工作空间绑定啦（因为我们系统会默认给未绑定集群的工作空间自动绑定最新集群，旧数据已经自动绑定啦，所以您在修正集群安装 id 时需要保留使用旧环境中的集群安装 id）

正常情况下使用 H2 数据时非集群默认，此列表仅存在一条记录时是正常的

#### 正常使用

当您一切都检查 ok 无问题后您就可以在新环境中使用 jpom 啦，不要忘记将新环境的地址告知给其他使用平台的用户奥

:::danger 友情提醒
上述操作流程时选用最复杂的流程来讲解，其实您可以在新环境中安装后服务端后不要启动，直接同步需要的文件到新环境中可以省去一些流程
:::

## 插件端

由于插件端本身数据较少并且机器中包含的项目关联文件较多，插件端不能给出一个完整的数据还原、导入的流程

如果您仅是想把插件端的数据迁移到新环境，我们建议您使用完整迁移插件端的方式（完整迁移方式文档有说明）
